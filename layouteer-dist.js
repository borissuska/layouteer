!function(t,e){var i=function(t){this.columnsCount=t.columnsCount||12,this.columnSize=t.columnSize||11,this.content=t.content||i.generateLayout(this.columnsCount,this.columnSize),this.editor=new i.Editor(t.editor,this)};i.init=function(t){return new i(t)},i.contentDimensions=function(t){var e=0,i=0,o=t.split("\n");i=o.length;for(var r=0;r<o.length;r++){var n=o[r].length;if(0==n)i--;else if(0==e)e=n;else if(e!=n)return!1}return{width:e,height:i}},i.generateRuler=function(t,e){for(var i="|",o="",r=0;r<e;r++)o+=" ";o+="|";for(r=0;r<t;r++)i+=o;return i},i.generateLayout=function(t,e){for(var i=t*e+t+1,o=Math.round(9.6*i/16*9/18),r="+",n="|",s=0;s<i-2;s++)r+="-",n+=" ";n+="|";var l=(r+="+")+"\n";for(s=0;s<o-2;s++)l+=n+"\n";return l+r},i.Editor=function(t,o){if(!t)throw"Editor element is not defined, unable create editor";var r=i.contentDimensions(o.content);if(!r)throw"Invalid content dimensions, unable create editor.";this.element=t,this.layouteer=o,this.index=new Array(r.height);for(var n=0;n<r.height;n++)this.index[n]=new Array(r.width);this.cursor=e,this.selection=e,this.bindToElement()},i.Editor.prototype.bindEventHandlers=function(){var t=this;this.element.addEventListener("click",function(e){t.setCursor(e.target._index)}),this.element.addEventListener("keydown",function(e){switch(e.code){case"ArrowDown":for(var i=t.cursor.bottom;(e.metaKey||e.ctrlKey)&&i&&!i.isHorizontalLine();)i=i.bottom;i&&t.setCursor(i);break;case"ArrowUp":for(i=t.cursor.top;(e.metaKey||e.ctrlKey)&&i&&!i.isHorizontalLine();)i=i.top;i&&t.setCursor(i);break;case"ArrowLeft":var o=t.cursor.left;(e.metaKey||e.ctrlKey||t.cursor.isHorizontalLine())&&(o=t.index[t.cursor.row][t.previousColumnIndex()]),o&&t.setCursor(o);break;case"ArrowRight":i=t.cursor.right;(e.metaKey||e.ctrlKey||t.cursor.isHorizontalLine())&&(i=t.index[t.cursor.row][t.nextColumnIndex()]),i&&t.setCursor(i);break;case"Backspace":if(t.cursor.isCorner())break;if(t.cursor.isHorizontalLine())for(var r=t.cursor.bottom;r&&r.isVerticalLine();){if(r.setValue("&nbsp;"),r.right&&r.right.isHorizontalLine()){var n=r;do{n.setValue("-"),n=n.left}while(n&&!n.isVerticalLine())}if(r.left&&r.left.isHorizontalLine()){var s=r;do{s.setValue("-"),s=s.right}while(s&&!s.isVerticalLine())}r=r.bottom}else if(t.cursor.isVerticalLine())for(s=t.cursor.right;s&&s.isHorizontalLine();){if(s.setValue("&nbsp;"),s.bottom&&s.bottom.isVerticalLine()){var l=s;do{l.setValue("|"),l=l.top}while(l&&!l.isHorizontalLine())}if(s.top&&s.top.isVerticalLine()){r=s;do{r.setValue("|"),r=r.bottom}while(r&&!r.isHorizontalLine())}s=s.right}break;case"Enter":if(t.cursor){var a=!1;for(s=t.cursor.right,n=t.cursor;s&&!a;)a=s.isHorizontalLine(),s=s.right;for(;n&&!a;)a=n.isHorizontalLine(),n,n=n.left;if(a)break}break;default:switch(e.key){case"+":t.makeNewBlock();break;case"|":t.makeColumn();break;case"-":t.makeRow();break;default:console.log("keydown",e)}}e.preventDefault()})},i.Editor.prototype.bindToElement=function(){this.element.classList.add("layouteer-editor"),this.element.tabIndex=1,this.bindEventHandlers();var t=document.createElement("div");t.classList.add("ruler"),t.innerHTML=i.generateRuler(this.layouteer.columnsCount,this.layouteer.columnSize).split(" ").join("&nbsp;"),this.element.appendChild(t);for(var o=0;o<this.index.length;o++){var r=this.index[o],n=document.createElement("div");this.element.appendChild(n);for(var s=0;s<r.length;s++){var l=this.layouteer.content[o*r.length+o+s],a=document.createElement("span");a.innerHTML=" "!=l?l:"&nbsp;",n.appendChild(a);var u=s>0?this.index[o][s-1]:e,c=o>0?this.index[o-1][s]:e,h=this.index[o][s]=new i.Editor.Cell({el:a,rowEl:n,row:o,column:s,left:u,top:c,right:e,bottom:e,line:e});a._index=h,u&&(u.right=h),c&&(c.bottom=h)}}this.__buildLineIndex__(),this.setCursor(this.index[0][0])},i.Editor.prototype.__buildLineIndex__=function(){this.getHLineInfo(this.index[0][0])},i.Editor.prototype.getHLineInfo=function(t){var e={horizontal:!0},i={},o=[],r=t,n=t;if(t){console.log("HLineIdx",t.row,t.column,t.el);for(var s=t;s&&s.isHorizontalLine();)s.line=e,i[s.column]=s,n=s,s.bottom&&s.bottom.isVerticalLine()&&o.push(this.getVlineInfo(s.bottom)),s=s.right}return e.cells=i,e.from=r,e.to=n,e.startingLines=o,e},i.Editor.prototype.getVlineInfo=function(t){var e={vertical:!0},i={},o=[],r=t,n=t;if(t){console.log("VLineIdx",t.row,t.column,t.el);for(var s=t;s&&s.isVerticalLine();)s.line=e,i[s.row]=s,n=s,s.right&&s.right.isHorizontalLine()&&o.push(this.getHLineInfo(s.right)),s=s.bottom}return e.cells=i,e.from=r,e.to=n,e.startingLines=o,e},i.Editor.prototype.setCursor=function(t){this.cursor&&this.cursor.el.classList.remove("cursor"),this.cursor=t,this.cursor&&this.cursor.el.classList.add("cursor")},i.Editor.prototype.nextColumnIndex=function(t){return t==e&&(t=this.cursor),(parseInt(t.column/(this.layouteer.columnSize+1))+1)*(this.layouteer.columnSize+1)},i.Editor.prototype.previousColumnIndex=function(t){return t==e&&(t=this.cursor),parseInt((t.column-1)/(this.layouteer.columnSize+1))*(this.layouteer.columnSize+1)},i.Editor.prototype.makeColumn=function(){if(this.cursor&&this.cursor.isHorizontalLine()){var t=Math.round(this.cursor.column/(this.layouteer.columnSize+1))*(this.layouteer.columnSize+1);this.setCursor(this.index[this.cursor.row][t]);for(var e=this.cursor;e.left&&e.isHorizontalLine();)e=e.left;var i=this.cursor,o=!1;do{for(i=i.bottom,e=e.bottom,o=!1;i&&!i.isHorizontalLine();)i.isVerticalLine()&&(o=!0),i.setValue("|"),i=i.bottom,e=e.bottom;(o=o&&e.isVerticalLine()&&!e.isCorner())&&i.setValue("|")}while(i&&o);this.__buildLineIndex__()}},i.Editor.prototype.makeRow=function(){if(this.cursor&&this.cursor.isVerticalLine()){for(var t=this.cursor;t.top&&t.isVerticalLine();)t=t.top;var e=this.cursor,i=!1;do{for(e=e.right,t=t.right,i=!1;e&&!e.isVerticalLine();)"-"==e.getValue()&&(i=!0),e.setValue("-"),e=e.right,t=t.right;(i=i&&t.isHorizontalLine()&&!t.isCorner())&&e.setValue("-")}while(e&&i);this.__buildLineIndex__()}},i.Editor.prototype.makeNewBlock=function(){this.cursor},i.Editor.Cell=function(t){this.el=t.el,this.rowEl=t.rowEl,this.row=t.row,this.column=t.column,this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom,this.line=t.line},i.Editor.Cell.prototype.isCorner=function(){return"+"==this.getValue()},i.Editor.Cell.prototype.isHorizontalLine=function(){return"-"==this.getValue()||this.isCorner()},i.Editor.Cell.prototype.isVerticalLine=function(){return"|"==this.getValue()||this.isCorner()},i.Editor.Cell.prototype.setValue=function(t){this.el.innerHTML=t},i.Editor.Cell.prototype.getValue=function(t){return this.el.innerHTML},t.layouteer=i}(window,void 0);